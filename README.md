# hddmail

`hddmail` monitors the SMART status of your disks and sends detailed email
reports. The `hddexec` launcher migrates legacy `/bin/hddmailFiles` installs to
`/opt/hddmailFiles`, keeps configuration files consistent, and makes sure
scheduled scans continue to run.

## Installation and upgrade

1. Download or update `hddexec` on the target machine.
2. Run `bash hddexec` once. The script will:
   - migrate existing data from `/bin/hddmailFiles` to `/opt/hddmailFiles`
     when the new directory does not yet exist,
   - place the executable wrapper at `/opt/hddmailFiles/hddmail`,
   - create the symlink `/usr/local/bin/hddmail`,
   - ensure strict permissions on configuration and status files, and
   - register shell completion for the main command.
3. Follow the interactive wizard (`hddmail --config`) to configure recipients,
   SMART dependencies (`smartmontools`), and the mail transfer agent (tested
   with `msmtp`).

All runtime data resides inside:

```
/opt/hddmailFiles/
├── hddexec            # main controller script
├── hddmail            # user facing wrapper (placed on PATH)
├── hddmail.cfg        # configuration generated by --config
├── hddsmart_status.json  # persistent SMART event tracker
├── hddsummary.txt     # textual SMART summary
├── hddstatus.txt      # textual SMART warnings
├── hddmail.txt        # plain-text email body
└── hddmailsend.txt    # HTML email body
```

## Usage

```
hddmail [option]
```

Available options:

- `--help` – display available commands.
- `--config` – run the interactive setup wizard.
- `--viewcfg` – print the current configuration.
- `--sendmail` – force an email report immediately.
- `--weekly` – run a full scan and send a report (designed for cron).
- `--daily` – run a scan and only send a report when new SMART issues appear.
- `--status` – print the last collected SMART status report.
- `--summary` – print the last collected SMART summary report.
- `--resetstore` – clear the SMART event tracker (`hddsmart_status.json`).

When the daily or weekly modes run from cron, the generated reports are stored
in `/opt/hddmailFiles` so they can be inspected locally even if email delivery
fails.

## SMART processing pipeline

- `smartctl` is invoked with `-j` to produce JSON output.
- Embedded Python code parses the JSON, updates
  `/opt/hddmailFiles/hddsmart_status.json`, and writes structured output files.
- When a monitored disk reports a new warning, `hddmail` logs the event via
  `logger -t hddmail ...` so administrators can follow activity with
  `journalctl -t hddmail`.
- The HTML email highlights problematic drives and counts affected devices in
the subject line.

## Maintenance tips

- Re-run `hddmail --config` whenever disks are added or removed.
- Use `hddmail --resetstore` after replacing or reformatting disks so the
  historic SMART event tracker starts fresh.
- Tab completion for the CLI is automatically re-applied on every invocation,
  but you can also reload it manually with:
  `complete -W '-h --help --sendmail --weekly --daily --config --viewcfg --status --summary --resetstore' hddmail`.

## Troubleshooting

- Verify that `/opt/hddmailFiles/hddsmart_status.json` contains valid JSON if
  scans fail. The file is automatically recreated when corrupted, but manual
  edits should keep it as a JSON object.
- Confirm that `msmtp` (or another `sendmail` compatible binary) is correctly
  configured. The installer can generate an example `/etc/msmtprc` snippet.
- Check `journalctl -t hddmail` for recent SMART issues or email delivery logs.
